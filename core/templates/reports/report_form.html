{% extends 'base.html' %}
{% load static %}
{% block content %}


<style>
    /* Shop Section - Orange theme */
    .accordion-button.shop {
        background-color: #fff4e6;
    }
    .accordion-button.shop:not(.collapsed) {
        background-color: #fd7e14;
        color: white;
    }

    /* Shop Stores Section - Blue theme */
    .accordion-button.shop-stores {
        background-color: #e7f5ff;
    }
    .accordion-button.shop-stores:not(.collapsed) {
        background-color: #339af0;
        color: white;
    }

    /* Main Store Section - Green theme */
    .accordion-button.main-store {
        background-color: #ebfbee;
    }
    .accordion-button.main-store:not(.collapsed) {
        background-color: #40c057;
        color: white;
    }

    /* Common styles */
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }

    /* Fix heading styles inside buttons */
    .accordion-button h5 {
        margin: 0;
        color: inherit;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div id="mainFormAlerts" class="mb-3"></div>
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Start a New Report</h3>
                </div>
                <form method="post" enctype="multipart/form-data" id="reportForm">
                    {% csrf_token %}
                        <!-- Accordion for Report Sections -->
                        <div class="accordion" id="reportSections">

                            <!-- Shop Section -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="shopSectionHeader">
                                    <button class="accordion-button shop" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#shopSection" 
                                            aria-expanded="true" 
                                            aria-controls="shopSection">
                                        <h5>Shop Information</h5>
                                    </button>
                                </h2>
                                <div id="shopSection" class="accordion-collapse collapse show" aria-labelledby="shopSectionHeader" data-bs-parent="#reportSections">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <!-- Shop Selection -->
                                            <!-- Shop Section -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="id_shop" class="form-label">Select Shop</label>
                                                    <div class="input-group">
                                                        {{ form.shop }}
                                                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addShopModal">
                                                            Add Shop
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Shop Auto-Populated Fields -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="shopAddress" class="form-label">Shop Address</label>
                                                    <input type="text" id="shopAddress" class="form-control" value="{{ selected_shop.address|default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="shopManagerName" class="form-label">Manager Name</label>
                                                    <input type="text" id="shopManagerName" class="form-control" value="{{ selected_shop.manager_name|default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="shopManagerPhone" class="form-label">Manager Phone</label>
                                                    <input type="text" id="shopManagerPhone" class="form-control" value="{{ selected_shop.manager_phone|default:'' }}" readonly>
                                                </div>
                                            </div>
                                            
                                                                                        
                                                                                        
                                            <div class="col-md-6 mb-3">
                                                <label for="id_product" class="form-label">Select Product</label>
                                                <div class="input-group">
                                                    {{ form.product }}
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                                        Add Product
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current Stock Quantity</label>
                                                {{ form.shop_current_quantity }}
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop Shelf Photo</label>
                                                {{ form.shop_photo }}
                                            </div>


                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Desired Stock Quantity</label>
                                                {{ form.desired_quantity }}
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    {{ form.needs_topup }}
                                                    <label class="form-check-label">Tick to get Top-up  quantity</label>
                                                </div>
                                            </div>


                                            <div class="col-md-6 mb-3" id="topupQuantityField">
                                                <label class="form-label">Desired Top-up Quantity</label>
                                                {{ form.topup_quantity }}
                                                <small class="form-text text-muted">Calculated: Desired - Current Quantity</small>
                                            </div>
                                            
                                            <script>
                                            document.addEventListener('DOMContentLoaded', function() {
                                                const currentQuantityInput = document.querySelector('[name="shop_current_quantity"]');
                                                const desiredQuantityInput = document.querySelector('[name="desired_quantity"]');
                                                const topupQuantityInput = document.querySelector('[name="topup_quantity"]');
                                                const needsTopupCheckbox = document.querySelector('[name="needs_topup"]');
                                            
                                                function calculateTopup() {
                                                    if (needsTopupCheckbox.checked) {
                                                        const current = parseInt(currentQuantityInput.value) || 0;
                                                        const desired = parseInt(desiredQuantityInput.value) || 0;
                                                        topupQuantityInput.value = Math.max(0, desired - current);
                                                    }
                                                }
                                            
                                                [currentQuantityInput, desiredQuantityInput, needsTopupCheckbox].forEach(input => {
                                                    input.addEventListener('change', calculateTopup);
                                                });
                                            });
                                            </script>
                                            <div class="mb-3">
                                                <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop Comments</label>
                                                {{ form.shop_comments }}
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shop Stores Section -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="shopStoresSectionHeader">
                                    <button class="accordion-button collapsed shop-stores" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#shopStoresSection" 
                                            aria-expanded="false" 
                                            aria-controls="shopStoresSection">
                                        <h5>Shop Stores Information</h5>
                                    </button>
                                </h2>
                                <div id="shopStoresSection" class="accordion-collapse collapse" aria-labelledby="shopStoresSectionHeader" data-bs-parent="#reportSections">
                                    <div class="accordion-body">
                                        <div class="row">

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="shopAddress" class="form-label">Shop-store Name</label>
                                                    <input type="text" id="shopAddress" class="form-control" value="{{ selected_shop.name | default:'' }}" readonly>
                                                </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="shopAddress" class="form-label">Shop Address</label>
                                                    <input type="text" id="shopAddress" class="form-control" value="{{ selected_shop.address | default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="shopManagerName" class="form-label">Manager Name</label>
                                                    <input type="text" id="shopManagerName" class="form-control" value="{{ selected_shop.stores_manager | default:'' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="shopManagerphone" class="form-label">Manager Phone</label>
                                                <input type="text" id="shopManagerPhone" class="form-control" value="{{ selected_shop.stores_manager_phone|default:'' }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop Shelf Photo</label>
                                                {{ form.shop_store_photo }}
                                            </div>
                                            

                                            <div class="mb-3">
                                                <div class="form-check">
                                                <label class="form-check-label">Tick if shop-stores has sufficient stock.</label>
                                                {{ form.shop_store_has_sufficient_stock }}
                                            </div>
                                        </div>
                                        


                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current quantity from Shop-Store</label>
                                                {{ form.shop_store_current_quantity }}
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Taken from Shop-Store</label>
                                                {{ form.quantity_taken_from_shop_store }}
                                            </div>


                                            <div class=" mb-3">
                                                <div class="form-check">
                                                  <label class="form-check-label">Tick to calculate updated shop quantity </label>
                                                   {{ form.was_shop_updated }}
                                                 </div>
                                              </div>                                            

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Remaining Shop-Store Quantity</label>
                                                {{ form.remaining_shop_store_quantity }}
                                            </div>


                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label"> If updated, provide Shop shelf Image</label>
                                                {{ form.shop_photo_update }}
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Final shop quantity</label>
                                                {{ form.shop_update_quantity}}
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop-Store Comments</label>
                                                {{ form.shop_store_comments }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const currentQuantityInput = document.querySelector('[name="shop_store_current_quantity"]');
                                    const desiredQuantityInput = document.querySelector('[name="quantity_taken_from_shop_store"]');
                                    const topupQuantityInput = document.querySelector('[name="remaining_shop_store_quantity"]');
                                    const needsTopupCheckbox = document.querySelector('[name="was_shop_updated"]');
                                
                                    function calculateTopup() {
                                        if (needsTopupCheckbox.checked) {
                                            const current = parseInt(currentQuantityInput.value) || 0;
                                            const desired = parseInt(desiredQuantityInput.value) || 0;
                                            topupQuantityInput.value = Math.max(0,  current-desired);
                                        }
                                    }
                                
                                    [currentQuantityInput, desiredQuantityInput, needsTopupCheckbox].forEach(input => {
                                        input.addEventListener('change', calculateTopup);
                                    });
                                });
                                </script>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const shopStoreForm = document.getElementById('reportForm');
                                        
                                        // Get all relevant input fields
                                        const wasShopUpdatedInput = document.querySelector('[name="was_shop_updated"]');
                                        const currentQuantityInput = document.querySelector('[name="shop_store_current_quantity"]');
                                        const takenQuantityInput = document.querySelector('[name="quantity_taken_from_shop_store"]');
                                        const remainingQuantityInput = document.querySelector('[name="remaining_shop_store_quantity"]');
                                        const shopCurrentQuantityInput = document.querySelector('[name="shop_current_quantity"]');
                                        const shopUpdateQuantityInput = document.querySelector('[name="shop_update_quantity"]');
                                    
                                        function updateCalculations() {
                                            if (wasShopUpdatedInput.checked) {
                                                const currentQty = Number(currentQuantityInput.value) || 0;
                                                const takenQty = Number(takenQuantityInput.value) || 0;
                                                const shopCurrentQty = Number(shopCurrentQuantityInput.value) || 0;
                                    
                                                // Calculate remaining quantity
                                                remainingQuantityInput.value = Math.max(0, currentQty - takenQty);
                                    
                                                // Calculate updated shop quantity
                                                shopUpdateQuantityInput.value = shopCurrentQty + takenQty;
                                            }
                                        }
                                    
                                        // Add event listeners
                                        wasShopUpdatedInput.addEventListener('change', updateCalculations);
                                        currentQuantityInput.addEventListener('input', updateCalculations);
                                        takenQuantityInput.addEventListener('input', updateCalculations);
                                        
                                        // Initial calculation
                                        updateCalculations();
                                    
                                        // Update before form submission
                                        shopStoreForm.addEventListener('submit', function(e) {
                                            if (wasShopUpdatedInput.checked) {
                                                updateCalculations();
                                            }
                                        });
                                    });
                                </script>

                            
                            <!-- Main stores section -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="mainStoreSectionHeader">
                                    <button class="accordion-button collapsed main-store" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#mainStoreSection" 
                                            aria-expanded="false" 
                                            aria-controls="mainStoreSection">
                                        <h5>Main Store Information</h5>
                                    </button>
                                </h2>
                                <div id="mainStoreSection" class="accordion-collapse collapse" aria-labelledby="mainStoreSectionHeader" data-bs-parent="#reportSections">
                                    <div class="accordion-body">
                                        <!-- Main Store Selection and Details -->
                                        <div class="row mb-4">
                                            <div class="col-12 mb-3">
                                                <label for="id_main_store" class="form-label">Select Main Store</label>
                                                <div class="input-group">
                                                    {{ form.main_store }}
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addMainStoreModal">
                                                        Add Main Store
                                                    </button>
                                                </div>
                                            </div>
                                
                                            <!-- Auto-populated Main Store Details -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="mainstoreAddress" class="form-label">Main Store Address</label>
                                                    <input type="text" id="mainstoreAddress" class="form-control" value="{{ selected_mainstore.location|default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="mainstoreManagerName" class="form-label">Manager Name</label>
                                                    <input type="text" id="mainstoreManagerName" class="form-control" value="{{ selected_mainstore.manager_name|default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="mainstoreManagerPhone" class="form-label">Manager Phone</label>
                                                    <input type="text" id="mainstoreManagerPhone" class="form-control" value="{{ selected_mainstore.manager_phone|default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="mainstoreManagerEmail" class="form-label">Manager Email</label>
                                                    <input type="text" id="mainstoreManagerEmail" class="form-control" value="{{ selected_mainstore.manager_email|default:'' }}" readonly>
                                                </div>
                                            </div>
                                
                                        <!-- Product Information and Quantities -->
                                        <div class="col-md-6 mb-3">
                                            <label for="productName" class="form-label">Product Name</label>
                                            <input type="text" id="productName" class="form-control" value="{{ selected_product.name|default:'' }}" readonly>
                                        </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Main Store Current Quantity</label>
                                                {{ form.main_store_quantity }}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Taken from Main Store</label>
                                                {{ form.quantity_taken_from_main_store }}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Remaining Main Store Quantity</label>
                                                {{ form.remaining_main_store_quantity }}
                                            </div>
                                        </div>
                                
                                        <!-- Photo Evidence and Comments -->
                                        <div class="row mb-4">
                                            <div class="col-12 mb-3">
                                                <label class="form-label">Main Store Photo Evidence</label>
                                                {{ form.main_store_photo }}
                                            </div>
                                           
                                
                                        <!-- Shop Store and Shop Distribution -->
                                        <div class="row mb-4">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Delivered to Shop Store</label>
                                                {{ form.delivered_to_shop_stores }}
                                            </div>

                                                <div class="mb-3">
                                                    <div class="form-check">
                                                    <label class="form-check-label">Tick to get updated shop-stores quantity updated? </label>
                                                    {{ form.was_shop_stores_updated }}
                                                </div>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Total Quantity in Shop Store</label>
                                                {{ form.quantity_in_shopstores }}
                                            </div>
                                                  
                                        <!-- Photo Evidence for Updates -->
                                        <div class="row mb-4">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current Shop Store Photo</label>
                                                {{ form.current_shop_store_photo }}
                                            </div>



                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Delivered to Shop</label>
                                                {{ form.delivered_to_shop }}
                                            </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                            <label class="form-check-label">Tick to get updated quantity?</label>
                                            {{ form.was_shop_m_updated }}
                                          </div>
                                        </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Total Quantity in Shop</label>
                                                {{ form.total_quantity_in_shop }}
                                            </div>
                                        </div>
                                         
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Current Shop Photo</label>
                                            {{ form.current_shop_photo }}
                                        </div>    
                                

                                            <div class="col-12 mb-3">
                                                <label class="form-label">Main Store Comments</label>
                                                {{ form.main_store_comments }}
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    console.log('Testing script load'); // This will confirm if any JavaScript runs at all
                                    
                                    document.addEventListener('DOMContentLoaded', function() {
                                        // Debug logs
                                        console.log('DOM loaded');
                                        
                                        // Get the selects
                                        const shopSelect = document.querySelector('select[name="shop"]');
                                        const mainStoreSelect = document.querySelector('select[name="main_store"]');
                                        const productSelect = document.querySelector('select[name="product"]');
                                        
                                        console.log('Found selects:', { shopSelect, mainStoreSelect, productSelect });
                                    
                                        // Simple change handlers
                                        shopSelect?.addEventListener('change', async function() {
                                            console.log('Shop changed:', this.value);
                                            const response = await fetch(`/track-n-trace/dynamic-fetch/?shop=${this.value}`);
                                            const data = await response.json();
                                            if (data.selected_shop) {
                                                document.getElementById('shopAddress').value = data.selected_shop.address || '';
                                                document.getElementById('shopManagerName').value = data.selected_shop.manager_name || '';
                                                document.getElementById('shopManagerPhone').value = data.selected_shop.manager_phone || '';
                                            }
                                        });
                                    
                                        mainStoreSelect?.addEventListener('change', async function() {
                                            console.log('Main store changed:', this.value);
                                            const response = await fetch(`/track-n-trace/dynamic-fetch/?main_store=${this.value}`);
                                            const data = await response.json();
                                            if (data.selected_mainstore) {
                                                document.getElementById('mainstoreAddress').value = data.selected_mainstore.location || '';
                                                document.getElementById('mainstoreManagerName').value = data.selected_mainstore.manager_name || '';
                                                document.getElementById('mainstoreManagerPhone').value = data.selected_mainstore.manager_phone || '';
                                                document.getElementById('mainstoreManagerEmail').value = data.selected_mainstore.manager_email || '';
                                            }
                                        });
                                    
                                        productSelect?.addEventListener('change', async function() {
                                            console.log('Product changed:', this.value);
                                            const response = await fetch(`/track-n-trace/dynamic-fetch/?product=${this.value}`);
                                            const data = await response.json();
                                            if (data.selected_product) {
                                                document.getElementById('productName').value = data.selected_product.name || '';
                                            }
                                        });
                                    });
                                    </script>
                            


                                </div>
                                <script>
                                    // Get form elements
                                    const mainStoreQuantityInput = document.querySelector('[name="main_store_quantity"]');
                                    const quantityTakenInput = document.querySelector('[name="quantity_taken_from_main_store"]');
                                    const remainingMainStoreInput = document.querySelector('[name="remaining_main_store_quantity"]');
                                    
                                    // Shop stores related elements
                                    const wasShopStoresUpdatedSelect = document.querySelector('[name="was_shop_stores_updated"]');
                                    const deliveredToShopStoresInput = document.querySelector('[name="delivered_to_shop_stores"]');
                                    const remainingShopStoreQuantityInput = document.querySelector('[name="remaining_shop_store_quantity"]');
                                    const quantityInShopStoresInput = document.querySelector('[name="quantity_in_shopstores"]');
                                    
                                    // Shop quantity related elements
                                    const wasShopUpdatedSelect = document.querySelector('[name="was_shop_m_updated"]');
                                    const deliveredToShopInput = document.querySelector('[name="delivered_to_shop"]');
                                    const shopCurrentQuantityInput = document.querySelector('[name="shop_current_quantity"]');
                                    const totalQuantityInShopInput = document.querySelector('[name="total_quantity_in_shop"]');
                                    
                                    
                                    // Main store calculation
                                    function calculateMainStoreRemaining() {
                                        const mainStoreQty = parseFloat(mainStoreQuantityInput.value) || 0;
                                        const quantityTaken = parseFloat(quantityTakenInput.value) || 0;
                                        const remaining = mainStoreQty - quantityTaken;
                                        remainingMainStoreInput.value = remaining;
                                    }
                                    
                                    function calculateShopStores() {
                                        const wasShopStoresUpdated = document.querySelector('[name="was_shop_stores_updated"]').checked;
                                        
                                        if (wasShopStoresUpdated) {
                                            const deliveredQty = parseFloat(deliveredToShopStoresInput.value) || 0;
                                            const remainingQty = parseFloat(remainingShopStoreQuantityInput.value) || 0;
                                            const total = deliveredQty + remainingQty;
                                            quantityInShopStoresInput.value = total;
                                        } else {
                                            quantityInShopStoresInput.value = '';
                                        }
                                    }

                                    // Shop quantity calculation
                                    function calculateShopQuantity() {
                                    const wasShopUpdated = document.querySelector('[name="was_shop_m_updated"]').checked;
                                    const deliveredQty = parseFloat(deliveredToShopInput.value) || 0;
                                    const shopUpdateQty = parseFloat(document.querySelector('[name="shop_update_quantity"]').value) || 0;
                                    const currentQty = parseFloat(shopCurrentQuantityInput.value) || 0;
                                
                                    let totalQty;
                                    if (wasShopUpdated) {
                                        // First check if shop_update_quantity is available
                                        if (shopUpdateQty > 0) {
                                            totalQty = deliveredQty + shopUpdateQty;
                                        } else {
                                            // Fallback to current quantity if shop_update_quantity is 0 or empty
                                            totalQty = deliveredQty + currentQty;
                                        }
                                    } else {
                                        totalQty = currentQty;
                                    }
                                    
                                    totalQuantityInShopInput.value = totalQty;
                                }
                                    
                                    // Add event listeners for main store calculations
                                    mainStoreQuantityInput.addEventListener('input', calculateMainStoreRemaining);
                                    quantityTakenInput.addEventListener('input', calculateMainStoreRemaining);
                                    
                                    // Add event listeners for shop stores calculations
                                    wasShopStoresUpdatedSelect.addEventListener('change', calculateShopStores);
                                    deliveredToShopStoresInput.addEventListener('input', calculateShopStores);
                                    remainingShopStoreQuantityInput.addEventListener('input', calculateShopStores);
                                    
                                    // Add event listeners for shop quantity calculations
                                    wasShopUpdatedSelect.addEventListener('change', calculateShopQuantity);
                                    deliveredToShopInput.addEventListener('input', calculateShopQuantity);
                                    shopCurrentQuantityInput.addEventListener('input', calculateShopQuantity);
                                    
                                    // Initial calculations
                                    calculateMainStoreRemaining();
                                    calculateShopStores();
                                    calculateShopQuantity();
                                </script>
                                
                                </div>
                                <!-- Hidden input for submission type -->
                               <input type="hidden" name="submission_type" id="submission_type" value="">
                               
                              <!-- Action buttons -->
                              <div class="btn-group" role="group">
                                  <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#draftModal">
                                      Save as Draft
                                  </button>
                                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitModal">
                                      Submit Report
                                  </button>
                              </div>
                          </form>
                             </div>
                                </div>
                              </div>
                         </div>
                    </div>
                    
            
                    <!-- Logout Button -->
                    <div class="mt-4">
                        <form action="{% url 'reptrack_trace:home' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                back to dashboard
                            </button>
                        </form>
                     </div>
                    
                    
                                                   <!-- Draft Modal -->
                              <div class="modal fade" id="draftModal" tabindex="-1">
                                  <div class="modal-dialog">
                                      <div class="modal-content">
                                          <div class="modal-header">
                                              <h5 class="modal-title">Save Report as Draft</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                          </div>
                                          <div class="modal-body">
                                              <p>Your report will be saved as a draft and can be edited later.</p>
                                          </div>
                                          <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                              <button type="submit" class="btn btn-primary submit-btn" name="submission_type" value="draft" form="reportForm">
                                                  <span class="button-text">Save Draft</span>
                                                  <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                              </button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- Submit Modal -->
                              <div class="modal fade" id="submitModal" tabindex="-1">
                                  <div class="modal-dialog">
                                      <div class="modal-content">
                                          <div class="modal-header">
                                              <h5 class="modal-title">Submit Final Report</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                          </div>
                                          <div class="modal-body">
                                              <p>Are you sure you want to submit this report?</p>
                                              <div class="alert alert-warning">
                                                  <p>This action cannot be undone.</p>
                                              </div>
                                          </div>
                                          <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                              <button type="submit" class="btn btn-primary submit-btn" name="submission_type" value="submit" form="reportForm">
                                                  <span class="button-text">Submit Report</span>
                                                  <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                              </button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const form = document.getElementById('reportForm');
                                    
                                    function handleButtonState(button, isSubmitting) {
                                        const spinner = button.querySelector('.spinner-border');
                                        const text = button.querySelector('.button-text');
                                        
                                        button.disabled = isSubmitting;
                                        if (spinner) {
                                            spinner.classList.toggle('d-none', !isSubmitting);
                                        }
                                        if (text) {
                                            text.style.opacity = isSubmitting ? '0.5' : '1';
                                        }
                                    }
                                    
                                    // Handle form submission
                                    form.addEventListener('submit', async function(e) {
                                        e.preventDefault();
                                        
                                        // Get the clicked button's submission type
                                        const submittedButton = document.activeElement;
                                        const submissionType = submittedButton.value;
                                        
                                        // Create or update hidden input for submission type
                                        let submissionTypeInput = form.querySelector('input[name="submission_type"]');
                                        if (!submissionTypeInput) {
                                            submissionTypeInput = document.createElement('input');
                                            submissionTypeInput.type = 'hidden';
                                            submissionTypeInput.name = 'submission_type';
                                            form.appendChild(submissionTypeInput);
                                        }
                                        submissionTypeInput.value = submissionType;
                                        
                                        // Show loading state on all submit buttons
                                        document.querySelectorAll('.submit-btn').forEach(button => {
                                            handleButtonState(button, true);
                                        });
                                        
                                        try {
                                            // Add a small delay to ensure the loading state is visible
                                            await new Promise(resolve => setTimeout(resolve, 500));
                                            
                                            // Create form data
                                            const formData = new FormData(form);
                                            
                                            // Submit the form programmatically
                                            form.submit();
                                            
                                            // Keep the modal open for a brief moment to show the loading state
                                            setTimeout(() => {
                                                const modal = bootstrap.Modal.getInstance(submittedButton.closest('.modal'));
                                                if (modal) {
                                                    modal.hide();
                                                }
                                            }, 800);
                                        } catch (error) {
                                            console.error('Submission error:', error);
                                            // Reset button states on error
                                            document.querySelectorAll('.submit-btn').forEach(button => {
                                                handleButtonState(button, false);
                                            });
                                            
                                            // Optionally show an error message to the user
                                            alert('There was an error submitting the form. Please try again.');
                                        }
                                    });
                                    
                                    // Reset button states when modal is closed
                                    document.querySelectorAll('.modal').forEach(modalEl => {
                                        modalEl.addEventListener('hidden.bs.modal', function() {
                                            document.querySelectorAll('.submit-btn').forEach(submitBtn => {
                                                handleButtonState(submitBtn, false);
                                            });
                                        });
                                    });
                                });
                              </script>
                       
                      <!-- Add Shop-->

                      <div class="modal fade" id="addShopModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Add Shop</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form hx-post="{% url 'reptrack_trace:create_shop' %}"
                                      hx-target="#shopFormContent"
                                      hx-swap="innerHTML">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div id="shopFormContent">
                                            {% include 'reports/partials/modal_form.html' with form=shop_form modal_id='addShopModal' %}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save Shop</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                                                                   
                                  <!-- Add Product Modal -->
                                  <div class="modal fade" id="addProductModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Add New Product</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form hx-post="{% url 'reptrack_trace:create_product' %}"
                                                  hx-target="#productFormContent"
                                                  hx-swap="innerHTML">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div id="productFormContent">
                                                        {% include 'reports/partials/product_form.html' %}
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">Save Product</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                    <!-- Add Store Modal -->
                
                           <div class="modal fade" id="newStoreModal" tabindex="-1">
                               <div class="modal-dialog modal-lg">
                                   <div class="modal-content">
                                       <div class="modal-header">
                                           <h5 class="modal-title">Add New Store</h5>
                                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                       </div>
                                       <form hx-post="{% url 'reptrack_trace:create_store' %}"
                                             hx-target="#storeFormContent"
                                             hx-swap="innerHTML">
                                           {% csrf_token %}
                                           <div class="modal-body">
                                               <div id="storeFormContent">
                                                   {% include 'reports/partials/modal_form.html' with form=store_form modal_id='newStoreModal' %}
                                               </div>
                                           </div>
                                           <div class="modal-footer">
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                               <button type="submit" class="btn btn-primary">Save Store</button>
                                           </div>
                                       </form>
                                   </div>
                               </div>
                           </div>
                           
                           <!-- Main Store Modal -->
                           <div class="modal fade" id="addMainStoreModal" tabindex="-1">
                               <div class="modal-dialog modal-lg">
                                   <div class="modal-content">
                                       <div class="modal-header">
                                           <h5 class="modal-title">Add New Main Store</h5>
                                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                       </div>
                                       <form hx-post="{% url 'reptrack_trace:create_main_store' %}"
                                             hx-target="#mainStoreFormContent"
                                             hx-swap="innerHTML">
                                           {% csrf_token %}
                                           <div class="modal-body">
                                               <div id="mainStoreFormContent">
                                                   {% include 'reports/partials/modal_form.html' with form=main_store_form modal_id='addMainStoreModal' %}
                                               </div>
                                           </div>
                                           <div class="modal-footer">
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                               <button type="submit" class="btn btn-primary">Save Main Store</button>
                                           </div>
                                       </form>
                                   </div>
                               </div>
                           </div>

                           <!-- Shop Store Modal -->
                           <div class="modal fade" id="newShopStoreModal" tabindex="-1">
                               <div class="modal-dialog modal-lg">
                                   <div class="modal-content">
                                       <div class="modal-header">
                                           <h5 class="modal-title">Add New Shop Store</h5>
                                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                       </div>
                                       <form hx-post="{% url 'reptrack_trace:create_shop_store' %}"
                                             hx-target="#shopStoreFormContent"
                                             hx-swap="innerHTML">
                                           {% csrf_token %}
                                           <div class="modal-body">
                                               <div id="shopStoreFormContent">
                                                   {% include 'reports/partials/modal_form.html' with form=shop_store_form modal_id='newShopStoreModal' %}
                                               </div>
                                           </div>
                                           <div class="modal-footer">
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                               <button type="submit" class="btn btn-primary">Save Shop Store</button>
                                           </div>
                                       </form>
                                   </div>
                               </div>
                           </div>
              
                


               
                
                
                {% endblock %}

    
{% block scripts %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/modal_handler.js' %}"></script>

<script>
        console.log('Testing script load'); // This will confirm if any JavaScript runs at all
        
        document.addEventListener('DOMContentLoaded', function() {
            // Debug logs
            console.log('DOM loaded');
            
            // Get the selects
            const shopSelect = document.querySelector('select[name="shop"]');
            const mainStoreSelect = document.querySelector('select[name="main_store"]');
            const productSelect = document.querySelector('select[name="product"]');
            
            console.log('Found selects:', { shopSelect, mainStoreSelect, productSelect });
        
            // Simple change handlers
            shopSelect?.addEventListener('change', async function() {
                console.log('Shop changed:', this.value);
                const response = await fetch(`/track-n-trace/dynamic-fetch/?shop=${this.value}`);
                const data = await response.json();
                if (data.selected_shop) {
                    document.getElementById('shopAddress').value = data.selected_shop.address || '';
                    document.getElementById('shopManagerName').value = data.selected_shop.manager_name || '';
                    document.getElementById('shopManagerPhone').value = data.selected_shop.manager_phone || '';
                }
            });
        
            mainStoreSelect?.addEventListener('change', async function() {
                console.log('Main store changed:', this.value);
                const response = await fetch(`/track-n-trace/dynamic-fetch/?main_store=${this.value}`);
                const data = await response.json();
                if (data.selected_mainstore) {
                    document.getElementById('mainstoreAddress').value = data.selected_mainstore.location || '';
                    document.getElementById('mainstoreManagerName').value = data.selected_mainstore.manager_name || '';
                    document.getElementById('mainstoreManagerPhone').value = data.selected_mainstore.manager_phone || '';
                    document.getElementById('mainstoreManagerEmail').value = data.selected_mainstore.manager_email || '';
                }
            });
        
            productSelect?.addEventListener('change', async function() {
                console.log('Product changed:', this.value);
                const response = await fetch(`/track-n-trace/dynamic-fetch/?product=${this.value}`);
                const data = await response.json();
                if (data.selected_product) {
                    document.getElementById('productName').value = data.selected_product.name || '';
                }
            });
        });
</script>
<script>
    function resetModal() {
        const modalContent = document.getElementById('productFormContent');
        modalContent.innerHTML = `
            {% include 'reports/partials/product_form.html' %}
        `;
    }
</script>

<script>
    document.querySelectorAll('#submitModal button[type="submit"]').forEach(button => {
        button.addEventListener('click', function () {
            // Add spinner to the button
            const spinner = document.createElement('span');
            spinner.className = 'spinner-border spinner-border-sm';
            spinner.setAttribute('role', 'status');
            spinner.setAttribute('aria-hidden', 'true');

            // Update the button UI
            this.innerHTML = ''; // Clear the button text
            this.appendChild(spinner); // Add the spinner
            this.appendChild(document.createTextNode(' Processing...')); // Add processing text
            this.disabled = true; // Disable the button to prevent multiple clicks

            // Allow natural form submission
        });
    });
</script>

 


{% endblock %}
