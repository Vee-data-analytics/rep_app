{% extends 'base.html' %}
{% load static %}
{% block content %}


<style>
    /* Shop Section - Orange theme */
    .accordion-button.shop {
        background-color: #fff4e6;
    }
    .accordion-button.shop:not(.collapsed) {
        background-color: #fd7e14;
        color: white;
    }

    /* Shop Stores Section - Blue theme */
    .accordion-button.shop-stores {
        background-color: #e7f5ff;
    }
    .accordion-button.shop-stores:not(.collapsed) {
        background-color: #339af0;
        color: white;
    }

    /* Main Store Section - Green theme */
    .accordion-button.main-store {
        background-color: #ebfbee;
    }
    .accordion-button.main-store:not(.collapsed) {
        background-color: #40c057;
        color: white;
    }

    /* Common styles */
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }

    /* Fix heading styles inside buttons */
    .accordion-button h5 {
        margin: 0;
        color: inherit;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div id="mainFormAlerts" class="mb-3"></div>
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Start a New Report</h3>
                </div>
                <form method="post" enctype="multipart/form-data" id="reportForm">
                    {% csrf_token %}
                        <!-- Accordion for Report Sections -->
                        <div class="accordion" id="reportSections">

                            <!-- Shop Section -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="shopSectionHeader">
                                    <button class="accordion-button shop" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#shopSection" 
                                            aria-expanded="true" 
                                            aria-controls="shopSection">
                                        <h5>Shop Information</h5>
                                    </button>
                                </h2>
                                <div id="shopSection" class="accordion-collapse collapse show" aria-labelledby="shopSectionHeader" data-bs-parent="#reportSections">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <!-- Shop Selection -->
                                             <div class="row mb-3">
                                                 <div class="col-md-6">
                                                     <label for="id_shop" class="form-label">Select Shop</label>
                                                     <div class="input-group">
                                                         {{ form.shop }}
                                                         <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addShopModal">
                                                             Add Shop
                                                         </button>
                                                     </div>
                                                 </div>
                                             </div>

                                             <!-- Auto-Populated Fields -->
                                             <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="shopAddress" class="form-label">Shop Address</label>
                                                    <input type="text" id="shopAddress" class="form-control" value="{{ selected_shop.address | default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="shopManagerName" class="form-label">Manager Name</label>
                                                    <input type="text" id="shopManagerName" class="form-control" value="{{ selected_shop.manager_name | default:'' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="shopManagerphone" class="form-label">Manager Phone</label>
                                                <input type="text" id="shopManagerPhone" class="form-control" value="{{ selected_shop.manager_phone|default:'' }}" readonly>
                                            </div>
                                            
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Select Product</label>
                                                <div class="input-group">
                                                    {{ form.product }}
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                                        Add Product
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current Stock Quantity</label>
                                                {{ form.shop_current_quantity }}
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop Shelf Photo</label>
                                                {{ form.shop_photo }}
                                            </div>


                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Desired Stock Quantity</label>
                                                {{ form.desired_quantity }}
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    {{ form.needs_topup }}
                                                    <label class="form-check-label">Tick if quantity needs Top-up</label>
                                                </div>
                                            </div>


                                            <div class="col-md-6 mb-3" id="topupQuantityField">
                                                <label class="form-label">Desired Top-up Quantity</label>
                                                {{ form.topup_quantity }}
                                                <small class="form-text text-muted">Calculated: Desired - Current Quantity</small>
                                            </div>
                                            
                                            <script>
                                            document.addEventListener('DOMContentLoaded', function() {
                                                const currentQuantityInput = document.querySelector('[name="shop_current_quantity"]');
                                                const desiredQuantityInput = document.querySelector('[name="desired_quantity"]');
                                                const topupQuantityInput = document.querySelector('[name="topup_quantity"]');
                                                const needsTopupCheckbox = document.querySelector('[name="needs_topup"]');
                                            
                                                function calculateTopup() {
                                                    if (needsTopupCheckbox.checked) {
                                                        const current = parseInt(currentQuantityInput.value) || 0;
                                                        const desired = parseInt(desiredQuantityInput.value) || 0;
                                                        topupQuantityInput.value = Math.max(0, desired - current);
                                                    }
                                                }
                                            
                                                [currentQuantityInput, desiredQuantityInput, needsTopupCheckbox].forEach(input => {
                                                    input.addEventListener('change', calculateTopup);
                                                });
                                            });
                                            </script>
                                            <div class="mb-3">
                                                <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop Comments</label>
                                                {{ form.shop_comments }}
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shop Stores Section -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="shopStoresSectionHeader">
                                    <button class="accordion-button collapsed shop-stores" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#shopStoresSection" 
                                            aria-expanded="false" 
                                            aria-controls="shopStoresSection">
                                        <h5>Shop Stores Information</h5>
                                    </button>
                                </h2>
                                <div id="shopStoresSection" class="accordion-collapse collapse" aria-labelledby="shopStoresSectionHeader" data-bs-parent="#reportSections">
                                    <div class="accordion-body">
                                        <div class="row">

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="shopAddress" class="form-label">Shop-store Name</label>
                                                    <input type="text" id="shopAddress" class="form-control" value="{{ selected_shop.name | default:'' }}" readonly>
                                                </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="shopAddress" class="form-label">Shop Address</label>
                                                    <input type="text" id="shopAddress" class="form-control" value="{{ selected_shop.address | default:'' }}" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="shopManagerName" class="form-label">Manager Name</label>
                                                    <input type="text" id="shopManagerName" class="form-control" value="{{ selected_shop.stores_manager | default:'' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="shopManagerphone" class="form-label">Manager Phone</label>
                                                <input type="text" id="shopManagerPhone" class="form-control" value="{{ selected_shop.stores_manager_phone|default:'' }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop Shelf Photo</label>
                                                {{ form.shop_store_photo }}
                                            </div>
                                            

                                            <div class="mb-3">
                                                <div class="form-check">
                                                <label class="form-check-label">Does stores have sufficient stock?</label>
                                                {{ form.shop_store_has_sufficient_stock }}
                                            </div>
                                        </div>
                                        


                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current quantity from Shop-Store</label>
                                                {{ form.shop_store_current_quantity }}
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Taken from Shop-Store</label>
                                                {{ form.quantity_taken_from_shop_store }}
                                            </div>

                                            
                                            <div class=" mb-3">
                                               <div class="form-check">
                                                 <label class="form-check-label">Was Shop quantity replenished ? </label>
                                                  {{ form.was_shop_updated }}
                                                </div>
                                             </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Remaining Shop-Store Quantity</label>
                                                {{ form.remaining_shop_store_quantity }}
                                            </div>


                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label"> If updated, provide Shop shelf Image</label>
                                                {{ form.shop_photo_update }}
                                            </div>


                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Shop-Store Comments</label>
                                                {{ form.shop_store_comments }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const currentQuantityInput = document.querySelector('[name="shop_store_current_quantity"]');
                                    const desiredQuantityInput = document.querySelector('[name="quantity_taken_from_shop_store"]');
                                    const topupQuantityInput = document.querySelector('[name="remaining_shop_store_quantity"]');
                                    const needsTopupCheckbox = document.querySelector('[name="was_shop_updated"]');
                                
                                    function calculateTopup() {
                                        if (needsTopupCheckbox.checked) {
                                            const current = parseInt(currentQuantityInput.value) || 0;
                                            const desired = parseInt(desiredQuantityInput.value) || 0;
                                            topupQuantityInput.value = Math.max(0,  current-desired);
                                        }
                                    }
                                
                                    [currentQuantityInput, desiredQuantityInput, needsTopupCheckbox].forEach(input => {
                                        input.addEventListener('change', calculateTopup);
                                    });
                                });
                                </script>

                            
                            <!-- Main stores section -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="mainStoreSectionHeader">
                                    <button class="accordion-button collapsed main-store" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#mainStoreSection" 
                                            aria-expanded="false" 
                                            aria-controls="mainStoreSection">
                                        <h5>Main Store Information</h5>
                                    </button>
                                </h2>
                                <div id="mainStoreSection" class="accordion-collapse collapse" aria-labelledby="mainStoreSectionHeader" data-bs-parent="#reportSections">
                                    <div class="accordion-body">
                                        <!-- Main Store Selection and Details -->
                                        <div class="row mb-4">
                                            <div class="col-12 mb-3">
                                                <label class="form-label">Select Main Store</label>
                                                <div class="input-group">
                                                    {{ form.main_store }}
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addMainStoreModal">
                                                        Add Main Store
                                                    </button>
                                                </div>
                                            </div>
                                
                                            <!-- Auto-populated Main Store Details -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Main Store Address</label>
                                                <input type="text" id="mainstoreAddress" class="form-control" value="{{ selected_mainstore.location|default:'' }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Manager Name</label>
                                                <input type="text" id="mainstoreManagerName" class="form-control" value="{{ selected_mainstore.manager_name|default:'' }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Manager Phone</label>
                                                <input type="text" id="mainstoreManagerPhone" class="form-control" value="{{ selected_mainstore.manager_phone|default:'' }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Manager Email</label>
                                                <input type="text" id="mainstoreManagerEmail" class="form-control" value="{{ selected_mainstore.manager_email|default:'' }}" readonly>
                                            </div>
                                        </div>
                                
                                        <!-- Product Information and Quantities -->
                                        <div class="row mb-4">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Product Name</label>
                                                <input type="text" class="form-control" value="{{ form.instance.product.name|default:'' }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Main Store Current Quantity</label>
                                                {{ form.main_store_quantity }}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Taken from Main Store</label>
                                                {{ form.quantity_taken_from_main_store }}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Remaining Main Store Quantity</label>
                                                {{ form.remaining_main_store_quantity }}
                                            </div>
                                        </div>
                                
                                        <!-- Photo Evidence and Comments -->
                                        <div class="row mb-4">
                                            <div class="col-12 mb-3">
                                                <label class="form-label">Main Store Photo Evidence</label>
                                                {{ form.main_store_photo }}
                                            </div>
                                           
                                
                                        <!-- Shop Store and Shop Distribution -->
                                        <div class="row mb-4">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Delivered to Shop Store</label>
                                                {{ form.delivered_to_shop_stores }}
                                            </div>

                                                <div class="mb-3">
                                                    <div class="form-check">
                                                    <label class="form-check-label">Was shop-stores quantity updated? </label>
                                                    {{ form.was_shop_stores_updated }}
                                                </div>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Total Quantity in Shop Store</label>
                                                {{ form.quantity_in_shopstores }}
                                            </div>
                                                  
                                        <!-- Photo Evidence for Updates -->
                                        <div class="row mb-4">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current Shop Store Photo</label>
                                                {{ form.current_shop_store_photo }}
                                            </div>



                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Quantity Delivered to Shop</label>
                                                {{ form.delivered_to_shop }}
                                            </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                            <label class="form-check-label">Was shop quantity updated ?</label>
                                            {{ form.was_shop_m_updated }}
                                          </div>
                                        </div>

                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Total Quantity in Shop</label>
                                                {{ form.total_quantity_in_shop }}
                                            </div>
                                        </div>
                                         
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Current Shop Photo</label>
                                            {{ form.current_shop_photo }}
                                        </div>    
                                

                                            <div class="col-12 mb-3">
                                                <label class="form-label">Main Store Comments</label>
                                                {{ form.main_store_comments }}
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        // Get input elements using the form field names from your HTML
                                        const mainStoreQuantityInput = document.querySelector('[name="main_store_quantity"]');
                                        const quantityTakenInput = document.querySelector('[name="quantity_taken_from_main_store"]');
                                        const remainingQuantityInput = document.querySelector('[name="remaining_main_store_quantity"]');
                                        
                                        function calculateRemainingQuantity() {
                                            // Get values and convert to integers, default to 0 if empty
                                            const currentQuantity = parseInt(mainStoreQuantityInput.value) || 0;
                                            const quantityTaken = parseInt(quantityTakenInput.value) || 0;
                                            
                                            // Calculate remaining quantity (ensure it's not negative)
                                            const remainingQuantity = Math.max(0, currentQuantity - quantityTaken);
                                            
                                            // Update the remaining quantity input
                                            remainingQuantityInput.value = remainingQuantity;
                                        }
                                        
                                        // Add event listeners to both inputs if they exist
                                        if (mainStoreQuantityInput && quantityTakenInput && remainingQuantityInput) {
                                            [mainStoreQuantityInput, quantityTakenInput].forEach(input => {
                                                input.addEventListener('input', calculateRemainingQuantity);
                                                input.addEventListener('change', calculateRemainingQuantity);
                                            });
                                        }
                                    });
                                </script>   


                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        // Get all relevant input fields
                                        const shopInitialQuantityInput = document.querySelector('[name="shop_current_quantity"]');
                                        const shopStoreInitialQuantityInput = document.querySelector('[name="shop_store_current_quantity"]');
                                        const deliveredToShopStoresInput = document.querySelector('[name="delivered_to_shop_stores"]');
                                        const quantityInShopStoresInput = document.querySelector('[name="quantity_in_shopstores"]');
                                        const deliveredToShopInput = document.querySelector('[name="delivered_to_shop"]');
                                        const totalQuantityInShopInput = document.querySelector('[name="total_quantity_in_shop"]');
                                        const wasShopStoresUpdatedSelect = document.querySelector('[name="was_shop_stores_updated"]');
                                        const wasShopUpdatedSelect = document.querySelector('[name="was_shop_m_updated"]');
                                    
                                        // Function to calculate shop stores total quantity
                                        function calculateShopStoresTotal() {
                                            if (wasShopStoresUpdatedSelect && wasShopStoresUpdatedSelect.value === 'Yes') {
                                                const initialQuantity = parseInt(shopStoreInitialQuantityInput.value) || 0;
                                                const deliveredQuantity = parseInt(deliveredToShopStoresInput.value) || 0;
                                                const totalQuantity = initialQuantity + deliveredQuantity;
                                                quantityInShopStoresInput.value = totalQuantity;
                                            }
                                        }
                                    
                                        // Function to calculate shop total quantity
                                        function calculateShopTotal() {
                                            if (wasShopUpdatedSelect && wasShopUpdatedSelect.value === 'Yes') {
                                                const initialQuantity = parseInt(shopInitialQuantityInput.value) || 0;
                                                const deliveredQuantity = parseInt(deliveredToShopInput.value) || 0;
                                                const totalQuantity = initialQuantity + deliveredQuantity;
                                                totalQuantityInShopInput.value = totalQuantity;
                                            }
                                        }
                                    
                                        // Add event listeners for shop stores calculations
                                        if (wasShopStoresUpdatedSelect && deliveredToShopStoresInput && shopStoreInitialQuantityInput) {
                                            [wasShopStoresUpdatedSelect, deliveredToShopStoresInput, shopStoreInitialQuantityInput].forEach(input => {
                                                input.addEventListener('change', calculateShopStoresTotal);
                                                input.addEventListener('input', calculateShopStoresTotal);
                                            });
                                        }
                                    
                                        // Add event listeners for shop calculations
                                        if (wasShopUpdatedSelect && deliveredToShopInput && shopInitialQuantityInput) {
                                            [wasShopUpdatedSelect, deliveredToShopInput, shopInitialQuantityInput].forEach(input => {
                                                input.addEventListener('change', calculateShopTotal);
                                                input.addEventListener('input', calculateShopTotal);
                                            });
                                        }
                                    
                                        // Initialize calculations
                                        calculateShopStoresTotal();
                                        calculateShopTotal();
                                    
                                        // Log for debugging
                                        console.log('Shop Stores Updated Select:', wasShopStoresUpdatedSelect);
                                        console.log('Shop Updated Select:', wasShopUpdatedSelect);
                                    });
                                </script>
                                </div>
                                <!-- Hidden input for submission type -->
                               <input type="hidden" name="submission_type" id="submission_type" value="">
                               
                              <!-- Action buttons -->
                              <div class="btn-group" role="group">
                                  <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#draftModal">
                                      Save as Draft
                                  </button>
                                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitModal">
                                      Submit Report
                                  </button>
                              </div>
                          </form>
                             </div>
                                </div>
                              </div>
                         </div>
                    </div>
                    
            
                    <!-- Logout Button -->
                    <div class="mt-4">
                        <form action="{% url 'reptrack_trace:home' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                back to dashboard
                            </button>
                        </form>
                     </div>
                    
                    
                                                   <!-- Draft Modal -->
                              <div class="modal fade" id="draftModal" tabindex="-1">
                                  <div class="modal-dialog">
                                      <div class="modal-content">
                                          <div class="modal-header">
                                              <h5 class="modal-title">Save Report as Draft</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                          </div>
                                          <div class="modal-body">
                                              <p>Your report will be saved as a draft and can be edited later.</p>
                                          </div>
                                          <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                              <button type="submit" class="btn btn-primary submit-btn" name="submission_type" value="draft" form="reportForm">
                                                  <span class="button-text">Save Draft</span>
                                                  <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                              </button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- Submit Modal -->
                              <div class="modal fade" id="submitModal" tabindex="-1">
                                  <div class="modal-dialog">
                                      <div class="modal-content">
                                          <div class="modal-header">
                                              <h5 class="modal-title">Submit Final Report</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                          </div>
                                          <div class="modal-body">
                                              <p>Are you sure you want to submit this report?</p>
                                              <div class="alert alert-warning">
                                                  <p>This action cannot be undone.</p>
                                              </div>
                                          </div>
                                          <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                              <button type="submit" class="btn btn-primary submit-btn" name="submission_type" value="submit" form="reportForm">
                                                  <span class="button-text">Submit Report</span>
                                                  <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                              </button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <script>
                              document.addEventListener('DOMContentLoaded', function() {
                                  const form = document.getElementById('reportForm');
                                  
                                  function handleButtonState(button, isSubmitting) {
                                      const spinner = button.querySelector('.spinner-border');
                                      const text = button.querySelector('.button-text');
                                      
                                      button.disabled = isSubmitting;
                                      if (spinner) {
                                          spinner.classList.toggle('d-none', !isSubmitting);
                                      }
                                      if (text) {
                                          text.style.opacity = isSubmitting ? '0.5' : '1';
                                      }
                                  }
                                  
                                  // Handle form submission
                                  form.addEventListener('submit', function(e) {
                                      e.preventDefault();
                                      
                                      // Get the clicked button's submission type
                                      const submittedButton = document.activeElement;
                                      const submissionType = submittedButton.value;
                                      
                                      // Create or update hidden input for submission type
                                      let submissionTypeInput = form.querySelector('input[name="submission_type"]');
                                      if (!submissionTypeInput) {
                                          submissionTypeInput = document.createElement('input');
                                          submissionTypeInput.type = 'hidden';
                                          submissionTypeInput.name = 'submission_type';
                                          form.appendChild(submissionTypeInput);
                                      }
                                      submissionTypeInput.value = submissionType;
                                      
                                      // Show loading state on all submit buttons
                                      document.querySelectorAll('.submit-btn').forEach(button => {
                                          handleButtonState(button, true);
                                      });
                                      
                                      // Close the modal
                                      const modal = bootstrap.Modal.getInstance(submittedButton.closest('.modal'));
                                      if (modal) {
                                          modal.hide();
                                      }
                                      
                                      // Actually submit the form
                                      form.submit();
                                  });
                                  
                                  // Reset button states when modal is closed
                                  document.querySelectorAll('.modal').forEach(modalEl => {
                                      modalEl.addEventListener('hidden.bs.modal', function() {
                                          document.querySelectorAll('.submit-btn').forEach(submitBtn => {
                                              handleButtonState(submitBtn, false);
                                          });
                                      });
                                  });
                              });
                              </script>
                       
                      <!-- Add Shop-->

                      <div class="modal fade" id="addShopModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Add Shop</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form hx-post="{% url 'reptrack_trace:create_shop' %}"
                                      hx-target="#shopFormContent"
                                      hx-swap="innerHTML">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div id="shopFormContent">
                                            {% include 'reports/partials/modal_form.html' with form=shop_form modal_id='addShopModal' %}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save Shop</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                                                                   
                                  <!-- Add Product Modal -->
                                  <div class="modal fade" id="addProductModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Add New Product</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form hx-post="{% url 'reptrack_trace:create_product' %}"
                                                  hx-target="#productFormContent"
                                                  hx-swap="innerHTML">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div id="productFormContent">
                                                        {% include 'reports/partials/product_form.html' %}
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">Save Product</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                    <!-- Add Store Modal -->
                
                           <div class="modal fade" id="newStoreModal" tabindex="-1">
                               <div class="modal-dialog modal-lg">
                                   <div class="modal-content">
                                       <div class="modal-header">
                                           <h5 class="modal-title">Add New Store</h5>
                                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                       </div>
                                       <form hx-post="{% url 'reptrack_trace:create_store' %}"
                                             hx-target="#storeFormContent"
                                             hx-swap="innerHTML">
                                           {% csrf_token %}
                                           <div class="modal-body">
                                               <div id="storeFormContent">
                                                   {% include 'reports/partials/modal_form.html' with form=store_form modal_id='newStoreModal' %}
                                               </div>
                                           </div>
                                           <div class="modal-footer">
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                               <button type="submit" class="btn btn-primary">Save Store</button>
                                           </div>
                                       </form>
                                   </div>
                               </div>
                           </div>
                           
                           <!-- Main Store Modal -->
                           <div class="modal fade" id="addMainStoreModal" tabindex="-1">
                               <div class="modal-dialog modal-lg">
                                   <div class="modal-content">
                                       <div class="modal-header">
                                           <h5 class="modal-title">Add New Main Store</h5>
                                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                       </div>
                                       <form hx-post="{% url 'reptrack_trace:create_main_store' %}"
                                             hx-target="#mainStoreFormContent"
                                             hx-swap="innerHTML">
                                           {% csrf_token %}
                                           <div class="modal-body">
                                               <div id="mainStoreFormContent">
                                                   {% include 'reports/partials/modal_form.html' with form=main_store_form modal_id='addMainStoreModal' %}
                                               </div>
                                           </div>
                                           <div class="modal-footer">
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                               <button type="submit" class="btn btn-primary">Save Main Store</button>
                                           </div>
                                       </form>
                                   </div>
                               </div>
                           </div>

                           <!-- Shop Store Modal -->
                           <div class="modal fade" id="newShopStoreModal" tabindex="-1">
                               <div class="modal-dialog modal-lg">
                                   <div class="modal-content">
                                       <div class="modal-header">
                                           <h5 class="modal-title">Add New Shop Store</h5>
                                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                       </div>
                                       <form hx-post="{% url 'reptrack_trace:create_shop_store' %}"
                                             hx-target="#shopStoreFormContent"
                                             hx-swap="innerHTML">
                                           {% csrf_token %}
                                           <div class="modal-body">
                                               <div id="shopStoreFormContent">
                                                   {% include 'reports/partials/modal_form.html' with form=shop_store_form modal_id='newShopStoreModal' %}
                                               </div>
                                           </div>
                                           <div class="modal-footer">
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                               <button type="submit" class="btn btn-primary">Save Shop Store</button>
                                           </div>
                                       </form>
                                   </div>
                               </div>
                           </div>
              
                


               
                
                
                {% endblock %}

    
{% block scripts %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/modal_handler.js' %}"></script>
<script>
    function resetModal() {
        const modalContent = document.getElementById('productFormContent');
        modalContent.innerHTML = `
            {% include 'reports/partials/product_form.html' %}
        `;
    }
</script>

<script>
    document.querySelectorAll('#submitModal button[type="submit"]').forEach(button => {
        button.addEventListener('click', function () {
            // Add spinner to the button
            const spinner = document.createElement('span');
            spinner.className = 'spinner-border spinner-border-sm';
            spinner.setAttribute('role', 'status');
            spinner.setAttribute('aria-hidden', 'true');

            // Update the button UI
            this.innerHTML = ''; // Clear the button text
            this.appendChild(spinner); // Add the spinner
            this.appendChild(document.createTextNode(' Processing...')); // Add processing text
            this.disabled = true; // Disable the button to prevent multiple clicks

            // Allow natural form submission
        });
    });
</script>

 
{% endblock %}
